version: '3.8'

# Distributed Search System - Production Ready
# One command: docker compose up
# Access: http://localhost:8090/search?q=distributed

services:
  # ==========================================================================
  # ETCD CLUSTER (3 nodes for fault tolerance)
  # ==========================================================================
  etcd0:
    image: quay.io/coreos/etcd:v3.5.12
    container_name: etcd0
    environment:
      - ETCDCTL_API=3
      - ETCD_NAME=etcd0
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd0:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd0:2380
      - ETCD_INITIAL_CLUSTER=etcd0=http://etcd0:2380,etcd1=http://etcd1:2380,etcd2=http://etcd2:2380
      - ETCD_INITIAL_CLUSTER_TOKEN=search-cluster
      - ETCD_INITIAL_CLUSTER_STATE=new
    ports:
      - "2381:2379"
    networks:
      - search-net
    healthcheck:
      test: ["CMD", "etcdctl", "--endpoints=http://127.0.0.1:2379", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 3

  etcd1:
    image: quay.io/coreos/etcd:v3.5.12
    container_name: etcd1
    environment:
      - ETCDCTL_API=3
      - ETCD_NAME=etcd1
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd1:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd1:2380
      - ETCD_INITIAL_CLUSTER=etcd0=http://etcd0:2380,etcd1=http://etcd1:2380,etcd2=http://etcd2:2380
      - ETCD_INITIAL_CLUSTER_TOKEN=search-cluster
      - ETCD_INITIAL_CLUSTER_STATE=new
    networks:
      - search-net
    healthcheck:
      test: ["CMD", "etcdctl",  "endpoint", "health", "--cluster"]
      interval: 5s
      timeout: 5s
      retries: 3

  etcd2:
    image: quay.io/coreos/etcd:v3.5.12
    container_name: etcd2
    environment:
      - ETCDCTL_API=3
      - ETCD_NAME=etcd2
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd2:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd2:2380
      - ETCD_INITIAL_CLUSTER=etcd0=http://etcd0:2380,etcd1=http://etcd1:2380,etcd2=http://etcd2:2380
      - ETCD_INITIAL_CLUSTER_TOKEN=search-cluster
      - ETCD_INITIAL_CLUSTER_STATE=new
    networks:
      - search-net
    healthcheck:
      test: ["CMD", "etcdctl",  "endpoint", "health", "--cluster"]
      interval: 5s
      timeout: 5s
      retries: 3

  # ==========================================================================
  # REDIS CACHE
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - search-net
    healthcheck:
      # Using redis-cli ping is the standard way to check health
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ==========================================================================
  # SHARD SERVICES (8 instances)
  # CRITICAL: Each shard registers with its container name (shard-N:8080)
  # Index path is base path - the -N suffix is added by --shard-id flag
  # ==========================================================================
  shard-0:
    build:
      context: .
      dockerfile: docker/Dockerfile.shard
    container_name: shard-0
    command: 
      - "--shard-id=0"
      - "--port=8080"
      - "--hostname=shard-0"
      - "--index=/app/search.bleve"
      - "--etcd=etcd0:2379,etcd1:2379,etcd2:2379"
    volumes:
      - ./search.bleve-0:/app/search.bleve-0
    networks:
      - search-net
    depends_on:
      etcd0:
        condition: service_healthy
      etcd1:
        condition: service_healthy
      etcd2:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  shard-1:
    build:
      context: .
      dockerfile: docker/Dockerfile.shard
    container_name: shard-1
    command:
      - "--shard-id=1"
      - "--port=8080"
      - "--hostname=shard-1"
      - "--index=/app/search.bleve"
      - "--etcd=etcd0:2379,etcd1:2379,etcd2:2379"
    volumes:
      - ./search.bleve-1:/app/search.bleve-1
    networks:
      - search-net
    depends_on:
      etcd0:
        condition: service_healthy
      etcd1:
        condition: service_healthy
      etcd2:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  shard-2:
    build:
      context: .
      dockerfile: docker/Dockerfile.shard
    container_name: shard-2
    command:
      - "--shard-id=2"
      - "--port=8080"
      - "--hostname=shard-2"
      - "--index=/app/search.bleve"
      - "--etcd=etcd0:2379,etcd1:2379,etcd2:2379"
    volumes:
      - ./search.bleve-2:/app/search.bleve-2
    networks:
      - search-net
    depends_on:
      etcd0:
        condition: service_healthy
      etcd1:
        condition: service_healthy
      etcd2:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  shard-3:
    build:
      context: .
      dockerfile: docker/Dockerfile.shard
    container_name: shard-3
    command:
      - "--shard-id=3"
      - "--port=8080"
      - "--hostname=shard-3"
      - "--index=/app/search.bleve"
      - "--etcd=etcd0:2379,etcd1:2379,etcd2:2379"
    volumes:
      - ./search.bleve-3:/app/search.bleve-3
    networks:
      - search-net
    depends_on:
      etcd0:
        condition: service_healthy
      etcd1:
        condition: service_healthy
      etcd2:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  shard-4:
    build:
      context: .
      dockerfile: docker/Dockerfile.shard
    container_name: shard-4
    command:
      - "--shard-id=4"
      - "--port=8080"
      - "--hostname=shard-4"
      - "--index=/app/search.bleve"
      - "--etcd=etcd0:2379,etcd1:2379,etcd2:2379"
    volumes:
      - ./search.bleve-4:/app/search.bleve-4
    networks:
      - search-net
    depends_on:
      etcd0:
        condition: service_healthy
      etcd1:
        condition: service_healthy
      etcd2:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  shard-5:
    build:
      context: .
      dockerfile: docker/Dockerfile.shard
    container_name: shard-5
    command:
      - "--shard-id=5"
      - "--port=8080"
      - "--hostname=shard-5"
      - "--index=/app/search.bleve"
      - "--etcd=etcd0:2379,etcd1:2379,etcd2:2379"
    volumes:
      - ./search.bleve-5:/app/search.bleve-5
    networks:
      - search-net
    depends_on:
      etcd0:
        condition: service_healthy
      etcd1:
        condition: service_healthy
      etcd2:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  shard-6:
    build:
      context: .
      dockerfile: docker/Dockerfile.shard
    container_name: shard-6
    command:
      - "--shard-id=6"
      - "--port=8080"
      - "--hostname=shard-6"
      - "--index=/app/search.bleve"
      - "--etcd=etcd0:2379,etcd1:2379,etcd2:2379"
    volumes:
      - ./search.bleve-6:/app/search.bleve-6
    networks:
      - search-net
    depends_on:
      etcd0:
        condition: service_healthy
      etcd1:
        condition: service_healthy
      etcd2:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  shard-7:
    build:
      context: .
      dockerfile: docker/Dockerfile.shard
    container_name: shard-7
    command:
      - "--shard-id=7"
      - "--port=8080"
      - "--hostname=shard-7"
      - "--index=/app/search.bleve"
      - "--etcd=etcd0:2379,etcd1:2379,etcd2:2379"
    volumes:
      - ./search.bleve-7:/app/search.bleve-7
    networks:
      - search-net
    depends_on:
      etcd0:
        condition: service_healthy
      etcd1:
        condition: service_healthy
      etcd2:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ==========================================================================
  # COORDINATOR (Query Router with Hot-Term Routing)
  # ==========================================================================
  coordinator:
    build:
      context: .
      dockerfile: docker/Dockerfile.coordinator
    container_name: coordinator
    ports:
      - "8090:8090"
    networks:
      - search-net
    depends_on:
      etcd0:
        condition: service_healthy
      redis:
        condition: service_healthy
      shard-0:
        condition: service_started
      shard-1:
        condition: service_started
      shard-2:
        condition: service_started
      shard-3:
        condition: service_started
      shard-4:
        condition: service_started
      shard-5:
        condition: service_started
      shard-6:
        condition: service_started
      shard-7:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8090/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ==========================================================================
  # SETUP SERVICE (Seed hot terms in etcd)
  # Runs once on startup
  # ==========================================================================
  setup:
    image: alpine:latest
    container_name: setup
    networks:
      - search-net
    depends_on:
      etcd0:
        condition: service_healthy
    environment:
      - ETCDCTL_API=3
    command:
      - /bin/sh
      - -c
      - |
        # Install etcd-ctl (the client) inside the Alpine container
        apk add --no-cache etcd-ctl
        
        echo "Waiting for cluster stabilization..."
        sleep 10
        
        # Configure the hot terms
        etcdctl --endpoints=http://etcd0:2379 put /hot_terms/distributed/shards "0,1"
        etcdctl --endpoints=http://etcd0:2379 put /hot_terms/go/shards "2,3"
        etcdctl --endpoints=http://etcd0:2379 put /hot_terms/python/shards "0,2"
        
        echo "âœ… Hot terms configured"
    restart: "no"

networks:
  search-net:
    driver: bridge